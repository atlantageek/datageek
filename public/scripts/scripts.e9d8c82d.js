var app=angular.module("autocomplete",[]);app.directive("autocomplete",function(){var a=-1;return{restrict:"E",scope:{searchParam:"=ngModel",suggestions:"=data",onType:"=onType",onSelect:"=onSelect"},controller:["$scope",function(a){a.selectedIndex=-1,a.setIndex=function(b){a.selectedIndex=parseInt(b)},this.setIndex=function(b){a.setIndex(b),a.$apply()},a.getIndex=function(){return a.selectedIndex};var b=!0;a.completing=!1,a.$watch("searchParam",function(c,d){d!==c&&(b&&a.searchParam&&(a.completing=!0,a.searchFilter=a.searchParam,a.selectedIndex=-1),a.onType&&a.onType(a.searchParam))}),this.preSelect=function(){b=!1,a.$apply(),b=!0},a.preSelect=this.preSelect,this.preSelectOff=function(){b=!0},a.preSelectOff=this.preSelectOff,a.select=function(c){c&&(a.searchParam=c,a.searchFilter=c,a.onSelect&&a.onSelect(c)),b=!1,a.completing=!1,setTimeout(function(){b=!0},1e3),a.setIndex(-1)}}],link:function(b,c,d){var e="";b.attrs={placeholder:"start typing...","class":"",id:"",inputclass:"",inputid:""};for(var f in d)e=f.replace("attr","").toLowerCase(),0===f.indexOf("attr")&&(b.attrs[e]=d[f]);d.clickActivation&&(c[0].onclick=function(){b.searchParam||(b.completing=!0,b.$apply())});var g={left:37,up:38,right:39,down:40,enter:13,esc:27};document.addEventListener("keydown",function(a){var c=a.keyCode||a.which;switch(c){case g.esc:b.select(),b.setIndex(-1),b.$apply(),a.preventDefault()}},!0),document.addEventListener("blur",function(){setTimeout(function(){b.select(),b.setIndex(-1),b.$apply()},200)},!0),c[0].addEventListener("keydown",function(c){var d=c.keyCode||c.which,e=angular.element(this).find("li").length;switch(d){case g.up:if(a=b.getIndex()-1,-1>a)a=e-1;else if(a>=e){a=-1,b.setIndex(a),b.preSelectOff();break}b.setIndex(a),-1!==a&&b.preSelect(angular.element(angular.element(this).find("li")[a]).text()),b.$apply();break;case g.down:if(a=b.getIndex()+1,-1>a)a=e-1;else if(a>=e){a=-1,b.setIndex(a),b.preSelectOff(),b.$apply();break}b.setIndex(a),-1!==a&&b.preSelect(angular.element(angular.element(this).find("li")[a]).text());break;case g.left:break;case g.right:case g.enter:a=b.getIndex(),-1!==a&&b.select(angular.element(angular.element(this).find("li")[a]).text()),b.setIndex(-1),b.$apply();break;case g.esc:b.select(),b.setIndex(-1),b.$apply(),c.preventDefault();break;default:return}(-1!==b.getIndex()||d==g.enter)&&c.preventDefault()})},template:'        <div class="autocomplete {{ attrs.class }}" id="{{ attrs.id }}">          <input            type="text"            ng-model="searchParam"            placeholder="{{ attrs.placeholder }}"            class="{{ attrs.inputclass }}"            id="{{ attrs.inputid }}"/>          <ul ng-show="completing">            <li              suggestion              ng-repeat="suggestion in suggestions | filter:searchFilter | orderBy:\'toString()\' track by $index"              index="{{ $index }}"              val="{{ suggestion }}"              ng-class="{ active: ($index === selectedIndex) }"              ng-click="select(suggestion)"              ng-bind-html="suggestion | highlight:searchParam"></li>          </ul>        </div>'}}),app.filter("highlight",["$sce",function(a){return function(b,c){if("function"==typeof b)return"";if(c){var d="("+c.split(/\ /).join(" |")+"|"+c.split(/\ /).join("|")+")",e=new RegExp(d,"gi");d.length&&(b=b.replace(e,'<span class="highlight">$1</span>'))}return a.trustAsHtml(b)}}]),app.directive("suggestion",function(){return{restrict:"A",require:"^autocomplete",link:function(a,b,c,d){b.bind("mouseenter",function(){d.preSelect(c.val),d.setIndex(c.index)}),b.bind("mouseleave",function(){d.preSelectOff()})}}}),angular.module("bobApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","autocomplete"]);var app=angular.module("bobApp");calculate_date_day=function(a){elems=a.split("-"),y=parseInt(elems[0]),m=parseInt(elems[1]),d=parseInt(elems[2]),days_by_month_idx=[0,0,31,59,90,120,151,181,212,243,273,304,334,365],y-=m/10;var b=365*y+y/4-y/100+y/400+days_by_month_idx[m]+d;return b},get_year=function(a){return elems=a.split("-"),elems[0]},generate_date=function(a){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],c=Math.floor(1e4*a/3652425),d=a-Math.floor(365.2425*c);days_by_month_idx=[0,31,59,90,120,151,181,212,243,273,304,334,365];var e;for(i=0;i<days_by_month_idx.length;i++)(d<=days_by_month_idx[i+1]&&d>days_by_month_idx[i]||i==days_by_month_idx.length)&&(e=b[i%12]);var f=(100*d+52)/3060;c+=(f+2)/12;return e+"-"+Math.round(c)},app.directive("clickToEdit",function(){var a='<div class="click-to-edit"><div ng-hide="view.editorEnabled">{{value}} <a ng-click="enableEditor()">Edit</a></div><div ng-show="view.editorEnabled"><input ng-model="view.editableValue"><a href="#" ng-click="save()">Save</a> or <a ng-click="disableEditor()">cancel</a>.</div></div>';return{restrict:"A",replace:!0,template:a,scope:{value:"=clickToEdit"},controller:["$scope",function(a){a.view={editableValue:a.value,editorEnabled:!1},a.enableEditor=function(){a.view.editorEnabled=!0,a.view.editableValue=a.value},a.disableEditor=function(){a.view.editorEnabled=!1},a.save=function(){a.value=a.view.editableValue,a.disableEditor()}}]}}),app.service("SelectedSeriesService",function(){this.metric_list=[],this.has_metric=function(a){return-1!=this.metric_list.indexOf(a)},this.empty=function(){return 0==this.metric_list?!0:!1},this.get_list=function(){return this.metric_list},this.display_list=function(){return this.metric_list.join(",")},this.remove_metric=function(a){idx=this.metric_list.indexOf(a),-1!=idx&&this.metric_list.splice(idx,1)},this.add_metric=function(a){this.has_metric(a)||this.metric_list.push(a)}}),app.config(["$routeProvider",function(a){a.when("/SelectSeries",{templateUrl:"templates/select_series.html",controller:"MetricSearchCtrl"}).when("/CombineSeries",{templateUrl:"templates/combine_series.html"}).otherwise({redirectTo:"/SelectSeries"})}]),app.controller("MetricSearchCtrl",["$scope","$http","$location","SelectedSeriesService",function(a,b,c,d){a.greetings="Hola!",a.yaxis1_title="Left Axis",a.yaxis2_title="Right Axis",a.yaxis_select={options:[{label:"none",value:"none"},{label:"Left Y-Axis",value:"left"},{label:"Right Y-Axis",value:"right"}]},a.month_list={options:[{label:"Jan.",month_idx:"01"},{label:"Feb.",month_idx:"02"},{label:"March",month_idx:"03"},{label:"April",month_idx:"04"},{label:"May",month_idx:"05"},{label:"June",month_idx:"06"},{label:"July",month_idx:"07"},{label:"Aug.",month_idx:"08"},{label:"Sept.",month_idx:"09"},{label:"Oct.",month_idx:"10"},{label:"Nov.",month_idx:"11"},{label:"Dec.",month_idx:"12"}]},a.year_list={options:[]},a.drawMe=function(a,c){b({method:"GET",url:"/metrics/show/"+a.id}).success(function(a){for(var b=[],d=[],e=0;e<a.length;e++)b[e]=[calculate_date_day(a[e][0]),a[e][1]];for(var e=0;e<a.length;e+=Math.round(a.length/5))d.push([e,a[e][0]]);$.plot(c,[b],{xaxis:{ticks:d}})})},a.drawMetrics=function(c){for(var d=0,e=0;e<a.selected_metrics.length;e++){d+=1;var f=[],g=a.selected_metrics[e];b({method:"GET",url:"/metrics/show/"+g.id,params:{start_date:a.start_year.label+"-"+a.start_month.month_idx+"-01",end_date:a.end_year.label+"-"+a.end_month.month_idx+"-01"}}).success(function(b){return function(c){for(var e=[],g=0;g<c.length;g++)dt_nbr=calculate_date_day(c[g][0]),e[g]=[dt_nbr,c[g][1]];d-=1,yaxis_idx=1,"left"==b.axis.value&&(yaxis_idx=1),"right"==b.axis.value&&(yaxis_idx=2),"none"!=b.axis.value?(f.push({data:e,yaxis:yaxis_idx,label:b.title}),0==d&&$.plot("#placeholder2",f,{axisLabels:{show:!0},xaxes:[{ticks:5,tickFormatter:generate_date,axisLabel:"Date",axisLabelUseCanvas:!0}],yaxes:[{position:"left",axisLabel:a.yaxis1_title,axisLabelUseCanvas:!0},{position:"right",axisLabel:"$scope.yaxis2_title",axisLabelUseCanvas:!0}]})):$("#placeholder2").empty()}}(g,c))}},a.getSearchData=function(){console.log(a.pattern2),b({method:"GET",url:"/metrics/index",params:{term:a.pattern2}}).success(function(b){a.first_year=null,a.common_first_year=null,a.last_year=null,a.common_last_year=null,a.metrics=b;for(var c=0;c<a.metrics.length;c++)a.metrics[c].selected=d.has_metric(a.metrics[c].id)})},a.hasSelections=function(){return!d.empty()},a.getSelectedData=function(){data={metric_list:d.get_list()},b({method:"GET",url:"/metrics/selected",params:data}).success(function(b){a.selected_metrics=b;for(var c=0;c<a.selected_metrics.length;c++)a.selected_metrics[c].axis=a.yaxis_select.options[0],(null==a.first_year||a.first_year>get_year(a.selected_metrics[c].min))&&(a.first_year=get_year(a.selected_metrics[c].min)),(null==a.last_year||a.last_year<get_year(a.selected_metrics[c].max))&&(a.last_year=get_year(a.selected_metrics[c].max));for(var c=parseInt(a.first_year);c<parseInt(a.last_year);c++)a.year_list.options.push({label:""+c});a.year_list})},a.selectMetric=function(b){console.log(b.selected),b.selected?d.add_metric(b.id):(d.remove_metric(b.id),a.first_year=null),a.getSelectedData(),console.log(d.display_list()),console.log(a.greetings)},a.metric_list=function(){return d.get_list}}]);